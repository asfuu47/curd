name: MERN Deployment via ACR
on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to ACR
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      - name: Build and Push Backend
        run: |
          docker build -t ${{ secrets.ACR_SERVER }}/backend-image:${{ github.sha }} ./backend
          docker push ${{ secrets.ACR_SERVER }}/backend-image:${{ github.sha }}

      - name: Build and Push Frontend
        run: |
          docker build -t ${{ secrets.ACR_SERVER }}/frontend-image:${{ github.sha }} ./frontned-app
          docker push ${{ secrets.ACR_SERVER }}/frontend-image:${{ github.sha }}

  deploy-backend:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: VM Pull and Run
        run: |
          az vm run-command invoke \
            --resource-group curd \
            --name backend-vm \
            --command-id RunShellScript \
            --scripts "
              # Login to ACR
              sudo docker login ${{ secrets.ACR_SERVER }} -u ${{ secrets.ACR_USERNAME }} -p ${{ secrets.ACR_PASSWORD }}
              
              # Safety Check: Ensure the path exists and is a FILE, not a directory
              mkdir -p /home/azureuser/app/curd/backend
              cd /home/azureuser/app/curd/backend
              if [ -d 'items.json' ]; then rm -rf items.json; fi
              if [ ! -f 'items.json' ]; then echo '[]' > items.json; fi
              chmod 666 items.json

              # Restart Container
              sudo docker rm -f mern-backend || true
              sudo docker pull ${{ secrets.ACR_SERVER }}/backend-image:${{ github.sha }}
              sudo docker run -d \
                --name mern-backend \
                -p 5000:5000 \
                --restart always \
                -v /home/azureuser/app/curd/backend/items.json:/app/items.json \
                ${{ secrets.ACR_SERVER }}/backend-image:${{ github.sha }}
            "

  deploy-frontend:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: VM Pull and Run
        run: |
          az vm run-command invoke \
            --resource-group curd \
            --name frontend-vm \
            --command-id RunShellScript \
            --scripts "
              sudo docker login ${{ secrets.ACR_SERVER }} -u ${{ secrets.ACR_USERNAME }} -p ${{ secrets.ACR_PASSWORD }}
              
              sudo docker rm -f mern-frontend || true
              sudo docker pull ${{ secrets.ACR_SERVER }}/frontend-image:${{ github.sha }}
              sudo docker run -d \
                --name mern-frontend \
                -p 80:80 \
                --restart always \
                ${{ secrets.ACR_SERVER }}/frontend-image:${{ github.sha }}
            "
