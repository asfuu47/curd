name: Deploy MERN App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # ðŸ§¾ Checkout your repo
      - name: Checkout code
        uses: actions/checkout@v3

      # ðŸ§° Install required tools (rsync, ssh)
      - name: Install rsync
        run: sudo apt-get update && sudo apt-get install -y rsync

      # ðŸ” Setup SSH key for frontend VM
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.FRONTEND_VM_KEY }}

      # ðŸ“– Add frontend server to known_hosts (avoid "Host key verification failed")
      - name: Add known host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.FRONTEND_IP }} >> ~/.ssh/known_hosts

      # ðŸš€ Deploy Frontend using rsync
      - name: Deploy Frontend
        run: |
          rsync -avz ./frontend/ azureuser@${{ secrets.FRONTEND_IP }}:/var/www/frontend/
          ssh azureuser@${{ secrets.FRONTEND_IP }} << 'EOF'
            cd /var/www/frontend
            npm install
            npm run build
            sudo cp -r build/* /var/www/html/
          EOF

      # ðŸ“¦ Deploy Backend via Jump Host (Frontend VM)
      - name: Deploy Backend via Frontend VM
        run: |
          # 1) Copy backend code to the jump host first
          rsync -avz ./backend/ azureuser@${{ secrets.FRONTEND_IP }}:~/backend-temp/

          # 2) SSH into Frontend VM and then SSH into Backend VM private IP
          ssh azureuser@${{ secrets.FRONTEND_IP }} << 'EOF'
            ssh -o "StrictHostKeyChecking=no" -i ~/.ssh/backend-vm_key.pem azureuser@${{ secrets.BACKEND_PRIVATE_IP }} << 'INNER'
              cd /home/azureuser/backend
              npm install
              pm2 restart backend-app || pm2 start index.js --name backend-app
            INNER
          EOF
