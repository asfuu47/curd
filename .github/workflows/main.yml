name: Deploy Secure MERN (Private Backend)
on:
  push:
    branches: [ main ]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Secure Backend Deploy (Private Subnet)
        run: |
          az vm run-command invoke \
            --resource-group curd \
            --name backend-vm \
            --command-id RunShellScript \
            --scripts "
              # 1. Install Docker (If missing)
              if ! command -v docker &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y ca-certificates curl gnupg
                sudo install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                sudo chmod a+r /etc/apt/keyrings/docker.gpg
                echo \"deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \$(. /etc/os-release && echo \"\$VERSION_CODENAME\") stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                sudo apt-get update
                sudo apt-get install -y docker-ce docker-ce-cli containerd.io
                sudo usermod -aG docker azureuser
              fi

              # 2. Sparse Checkout (Only fetch 'backend' folder)
              mkdir -p /home/azureuser/app
              cd /home/azureuser/app
              
              # Initialize git if not present
              if [ ! -d 'curd' ]; then
                git clone --filter=blob:none --no-checkout https://github.com/asfuu47/curd.git
              fi
              
              cd curd
              git sparse-checkout init --cone
              git sparse-checkout set backend
              git pull origin main
              git checkout main

              # 3. Build & Run Backend
              cd backend
              sudo docker build -t backend-image .
              sudo docker stop mern-backend || true
              sudo docker rm mern-backend || true
              # Running on port 5000 (accessible only by Frontend VM inside the vNet)
              sudo docker run -d --name mern-backend -p 5000:5000 --restart always backend-image
            "

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Public Frontend Deploy
        run: |
          az vm run-command invoke \
            --resource-group curd \
            --name frontend-vm \
            --command-id RunShellScript \
            --scripts "
              # 1. Install Docker (If missing)
              if ! command -v docker &> /dev/null; then
                sudo apt-get update
                sudo apt-get install -y ca-certificates curl gnupg
                sudo install -m 0755 -d /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                sudo chmod a+r /etc/apt/keyrings/docker.gpg
                echo \"deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \$(. /etc/os-release && echo \"\$VERSION_CODENAME\") stable\" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                sudo apt-get update
                sudo apt-get install -y docker-ce docker-ce-cli containerd.io
                sudo usermod -aG docker azureuser
              fi

              # 2. Sparse Checkout (Only fetch 'frontned-app' folder)
              mkdir -p /home/azureuser/app
              cd /home/azureuser/app
              
              if [ ! -d 'curd' ]; then
                git clone --filter=blob:none --no-checkout https://github.com/asfuu47/curd.git
              fi
              
              cd curd
              git sparse-checkout init --cone
              git sparse-checkout set frontned-app
              git pull origin main
              git checkout main

              # 3. Build & Run Frontend
              cd frontned-app
              sudo docker build -t frontend-image .
              sudo docker stop mern-frontend || true
              sudo docker rm mern-frontend || true
              sudo docker run -d --name mern-frontend -p 80:80 --restart always frontend-image
            "
