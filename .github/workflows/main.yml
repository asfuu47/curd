name: Secure MERN Deployment (Private Backend)
on:
  push:
    branches: [ main ]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Backend (Private VM)
        run: |
          az vm run-command invoke \
            --resource-group curd \
            --name backend-vm \
            --command-id RunShellScript \
            --scripts "
              mkdir -p /home/azureuser/app
              cd /home/azureuser/app
              
              # 1. Sparse Checkout (Only backend files)
              if [ ! -d 'curd' ]; then
                git clone --filter=blob:none --no-checkout https://github.com/asfuu47/curd.git
              fi
              cd curd
              git sparse-checkout init --cone
              git sparse-checkout set backend
              git pull origin main

              # 2. Fix the 'items.json' Folder vs File issue
              cd backend
              if [ -d 'items.json' ]; then rm -rf items.json; fi
              if [ ! -f 'items.json' ]; then echo '[]' > items.json; fi
              chmod 666 items.json

              # 3. Build & Force Restart
              sudo docker build -t backend-image .
              sudo docker rm -f mern-backend || true
              sudo docker run -d \
                --name mern-backend \
                -p 5000:5000 \
                --restart always \
                -v /home/azureuser/app/curd/backend/items.json:/app/items.json \
                backend-image
            "

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Frontend (Public VM)
        run: |
          az vm run-command invoke \
            --resource-group curd \
            --name frontend-vm \
            --command-id RunShellScript \
            --scripts "
              mkdir -p /home/azureuser/app
              cd /home/azureuser/app
              
              # 1. Sparse Checkout (Only frontend files)
              if [ ! -d 'curd' ]; then
                git clone --filter=blob:none --no-checkout https://github.com/asfuu47/curd.git
              fi
              cd curd
              git sparse-checkout init --cone
              git sparse-checkout set frontned-app
              git pull origin main

              # 2. Build & Force Restart
              cd frontned-app
              sudo docker build -t frontend-image .
              sudo docker rm -f mern-frontend || true
              sudo docker run -d \
                --name mern-frontend \
                -p 80:80 \
                --restart always \
                frontend-image
            "
