name: Deploy MERN Stack to Azure VMs

on:
  push:
    branches: [ main ]

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Backend to VM
        run: |
          az vm run-command invoke \
            --resource-group curd \
            --name backend-vm \
            --command-id RunShellScript \
            --scripts "
              cd /home/azureuser/app/backend
              sudo git pull origin main
              sudo docker build -t backend-image .
              sudo docker stop mern-backend || true
              sudo docker rm mern-backend || true
              sudo docker run -d --name mern-backend -p 5000:5000 \
                -v /home/azureuser/app/backend/items.json:/app/items.json \
                --restart always backend-image
            "

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Frontend to VM
        run: |
          az vm run-command invoke \
            --resource-group curd \
            --name frontend-vm \
            --command-id RunShellScript \
            --scripts "
              cd /home/azureuser/app/frontned-app
              sudo git pull origin main
              sudo docker build -t frontend-image .
              sudo docker stop mern-frontend || true
              sudo docker rm mern-frontend || true
              sudo docker run -d --name mern-frontend -p 80:80 --restart always frontend-image
            "
